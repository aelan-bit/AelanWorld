#!/usr/bin/env bash
set -euo pipefail

# --- CONFIG ---
PRIVATE_DIR="/mnt/c/Users/dario/Documents/Hobby/DnD/Aelan"
PUBLIC_CONTENT_DIR="$PWD/content"

# 0) Reset public content (keep folder itself)
mkdir -p "$PUBLIC_CONTENT_DIR"
find "$PUBLIC_CONTENT_DIR" -mindepth 1 -maxdepth 1 -exec rm -rf {} +

echo "[1/4] Selecting markdown with publish: true…"
# Allow leading spaces in frontmatter key
mapfile -t PUBLISHED_MD < <(rg -nU --glob '*.md' --glob '!**/.git/**' '^\s*publish:\s*true\s*$' "$PRIVATE_DIR" \
  -g '!**/node_modules/**' -g '!**/.quartz-cache/**' -g '!**/.obsidian/**' -g '!**/.git/**' \
  | cut -d: -f1 | sort -u)
echo "  -> ${#PUBLISHED_MD[@]} files marked publish:true"

echo "[2/4] Adding anything under PublicExport/ (if exists)…"
if [ -d "$PRIVATE_DIR/PublicExport" ]; then
  mapfile -t FOLDER_MD < <(find "$PRIVATE_DIR/PublicExport" -type f -name '*.md')
else
  FOLDER_MD=()
fi

# Union + de-dup
ALL_MD=("${PUBLISHED_MD[@]}" "${FOLDER_MD[@]}")
readarray -t ALL_MD < <(printf "%s\n" "${ALL_MD[@]}" | awk '!seen[$0]++')
echo "  -> total selected: ${#ALL_MD[@]}"

echo "[3/4] Copying selected notes to Quartz content/ (preserving tree)…"
for f in "${ALL_MD[@]}"; do
  rel="${f#"$PRIVATE_DIR/"}"
  dest="$PUBLIC_CONTENT_DIR/$rel"
  mkdir -p "$(dirname "$dest")"
  rsync -a "$f" "$dest"
done

# Copy common asset folders if present
for assets in "attachments" "assets" "img" "images"; do
  if [ -d "$PRIVATE_DIR/$assets" ]; then
    mkdir -p "$PUBLIC_CONTENT_DIR/$assets"
    rsync -a --delete "$PRIVATE_DIR/$assets/" "$PUBLIC_CONTENT_DIR/$assets/"
  fi
done

echo "[4/4] Ensure a homepage (content/index.md)…"
# Prefer a note named Home.md; else any note with homepage:true; else generate a minimal index
HOME_SOURCE=""
for f in "${ALL_MD[@]}"; do
  if [ "$(basename "$f")" = "Home.md" ]; then
    HOME_SOURCE="$f"
    break
  fi
done
if [ -z "$HOME_SOURCE" ] && [ "${#ALL_MD[@]}" -gt 0 ]; then
  if rg -nU --glob '!**/.git/**' '^\s*homepage:\s*true\s*$' "${ALL_MD[@]}" >/dev/null 2>&1; then
    HOME_SOURCE="$(rg -nU --glob '!**/.git/**' '^\s*homepage:\s*true\s*$' "${ALL_MD[@]}" | head -n1 | cut -d: -f1)"
  fi
fi

if [ -n "${HOME_SOURCE}" ]; then
  rel="${HOME_SOURCE#"$PRIVATE_DIR/"}"
  cp "$PUBLIC_CONTENT_DIR/$rel" "$PUBLIC_CONTENT_DIR/index.md"
  echo "  -> Using $(basename "$rel") as homepage"
else
  cat > "$PUBLIC_CONTENT_DIR/index.md" <<'EOT'


